---
title: "homelessness 1"
author: "Harrison Linder"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(ggplot2)
library(reshape2)
```

## data sources

I am using two main data sources. The first is PIT and HIC count data from HUD. The specific data table used was created in excel by me. The second data sources comes from California's HDIS data and is directly queried from their website

```{r reading data}
PITdata <- read_excel("PIT count data 2019 to 2023.xlsx")

HDISdata <- read.csv("https://data.ca.gov/dataset/c7ed1ae4-4f93-4fc7-b603-3cd07a55d862/resource/b1a5ae24-5842-425c-b56c-aa90f8f1c767/download/homelessness-count-by-age.csv")
```

```{r adding pit count totals}
pittotals <- PITdata %>%
    group_by(year) %>%
    summarise(`Overall Homeless` = sum(`Overall Homeless`), 
              `Sheltered Total Homeless` = sum(`Sheltered Total Homeless`),
              `Unsheltered Homeless` = sum(`Unsheltered Homeless`),
              `Total Year-Round Beds (ES, TH, SH)` = sum(`Total Year-Round Beds (ES, TH, SH)`),
              `Total Year-Round Beds (RRH)` = sum(`Total Year-Round Beds (RRH)`),
              `Total Year-Round Beds (PSH)` = sum(`Total Year-Round Beds (PSH)`),
              `Total Year-Round Beds (OPH)` = sum(`Total Year-Round Beds (OPH)`)
              ) %>%
            ungroup()

PITdata <- bind_rows(PITdata, pittotals) 
 
PITdata <- PITdata %>%
    mutate(`CoC Name` = ifelse(is.na(`CoC Name`), "California", `CoC Name`), `CoC Number` = ifelse(is.na(`CoC Number`), "All", `CoC Number`))

```

the PITdata is already ready to use, but I want to simplify my HDIS data by combining all the ages tranches into a total count. I will also match the years in the `PITdata` so that I can join the two datasets together.

```{r summarizing HDIS data}
HDISdata$EXPERIENCING_HOMELESSNESS_CNT <- as.numeric(HDISdata$EXPERIENCING_HOMELESSNESS_CNT) # making the count a numeric vector instead of a character vector

HDISdata <-HDISdata %>%
    mutate(EXPERIENCING_HOMELESSNESS_CNT = ifelse(is.na(EXPERIENCING_HOMELESSNESS_CNT),0, EXPERIENCING_HOMELESSNESS_CNT))

HDISyearlytotals <- HDISdata %>%
    group_by(CALENDAR_YEAR, LOCATION_ID, LOCATION) %>%
    summarise(hdistotal_count = sum(EXPERIENCING_HOMELESSNESS_CNT))
```

joining hdis data with pit data

```{r joining pit and hdis}
PITdata <- PITdata %>%
    rename( LOCATION_ID = `CoC Number`)

HDISyearlytotals <- HDISyearlytotals %>%
    rename(year = CALENDAR_YEAR)

PITandHDIS <- PITdata %>%
    left_join(HDISyearlytotals[,c("year", "LOCATION_ID", "hdistotal_count")], by = c("year", "LOCATION_ID"))
    
PITandHDIS <- PITandHDIS %>%
    select(-starts_with("..."))

PITandHDIS <- PITandHDIS %>%
    select(-`Count Types`)

PITandHDIS <- PITandHDIS %>%
    mutate(total_permanent_housing = `Total Year-Round Beds (OPH)` + `Total Year-Round Beds (RRH)` + `Total Year-Round Beds (PSH)`)


PITandHDIS <- PITandHDIS %>%
    rename(pittotal_count = `Overall Homeless`)
```

plotting state homelessness numbers for all of california pit vs hdis

```{r statewide numbers}
ggplot(PITandHDIS[PITandHDIS$LOCATION_ID == "All", ]) +
  geom_bar(aes(x = year, y = hdistotal_count, fill = "hdistotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = hdistotal_count, label = hdistotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  geom_bar(aes(x = year, y = pittotal_count, fill = "pittotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = pittotal_count, label = pittotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  labs(
    x = "Year",
    y = "Count",
    title = "California Homeless Population Counts Over Time"
  ) +
  scale_fill_manual(name = "Count Type", values = c("hdistotal_count" = "yellow", "pittotal_count" = "blue"))

```

plotting Homelessness for San Francisco
```{r san francisco numbers}
ggplot(PITandHDIS[PITandHDIS$LOCATION_ID == "CA-501", ]) +
  geom_bar(aes(x = year, y = hdistotal_count, fill = "hdistotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = hdistotal_count, label = hdistotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.8) +
  geom_bar(aes(x = year, y = pittotal_count, fill = "pittotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = pittotal_count, label = pittotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  labs(
    x = "Year",
    y = "Count",
    title = "San Francisco Homeless Population Counts Over Time"
  ) +
  scale_fill_manual(name = "Count Type", values = c("hdistotal_count" = "yellow", "pittotal_count" = "blue"))
```
Sacramento
```{r}
ggplot(PITandHDIS[PITandHDIS$LOCATION_ID == "CA-503", ]) +
  geom_bar(aes(x = year, y = hdistotal_count, fill = "hdistotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = hdistotal_count, label = hdistotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  geom_bar(aes(x = year, y = pittotal_count, fill = "pittotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = pittotal_count, label = pittotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  labs(
    x = "Year",
    y = "Count",
    title = "Sacramento Homeless Population Counts Over Time"
  ) +
  scale_fill_manual(name = "Count Type", values = c("hdistotal_count" = "yellow", "pittotal_count" = "blue"))
```
Los Angeles
```{r}
ggplot(PITandHDIS[PITandHDIS$LOCATION_ID == "CA-600", ]) +
  geom_bar(aes(x = year, y = hdistotal_count, fill = "hdistotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = hdistotal_count, label = hdistotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  geom_bar(aes(x = year, y = pittotal_count, fill = "pittotal_count"), 
           stat = "identity", position = "dodge") +
  geom_text(aes(x = year, y = pittotal_count, label = pittotal_count), 
            position = position_dodge(width = 0.9), vjust = -0.3) +
  labs(
    x = "Year",
    y = "Count",
    title = "Los Angeles Homeless Population Counts Over Time"
  ) +
  scale_fill_manual(name = "Count Type", values = c("hdistotal_count" = "yellow", "pittotal_count" = "blue"))
```
`
```{r long data}
longPITandHDIS <- melt(PITandHDIS,
id.vars = c("year", "LOCATION_ID", "CoC Name"),
measure.vars = c("hdistotal_count","pittotal_count", "Unsheltered Homeless", "Sheltered Total Homeless",  "Total Year-Round Beds (ES, TH, SH)", "total_permanent_housing"),
variable.name = "Count_Type",
value.name = "Count")
```

```{r}
ggplot(longPITandHDIS[longPITandHDIS$LOCATION_ID == "All",], aes(x = year, y = Count, fill = Count_Type)) +
  geom_bar(stat = "identity", position = position_dodge()) +  # Dodge bars side by side
  geom_text(aes(label = Count), 
            position = position_dodge(width = 0.9), vjust = -0.3, size = 2.5) +  # Add labels above bars
  labs(
    x = "Year",
    y = "Count",
    title = "California Homeless Population Counts Over Time"
  ) 

ggplot(longPITandHDIS[longPITandHDIS$LOCATION_ID == "All",], aes(x = factor(year), y = Count, color = Count_Type, group = Count_Type)) +
  geom_line(size = 1) +  # Draw the lines
  geom_point(size = 2) +  # Add points to the lines
  geom_text(aes(label = Count), 
            size = 2.5, vjust = -0.5, hjust = 0.5) +  # Add labels to points
  labs(
    x = "Year",
    y = "Count",
    title = "California Homeless Population Counts Over Time"
  )
```
```{r}
ggplot(longPITandHDIS[longPITandHDIS$LOCATION_ID == "CA-501",], aes(x = year, y = Count, fill = Count_Type)) +
  geom_bar(stat = "identity", position = position_dodge()) +  # Dodge bars side by side
  geom_text(aes(label = Count), 
            position = position_dodge(width = 0.9), vjust = -0.3, size = 2.5) +  # Add labels above bars
  labs(
    x = "Year",
    y = "Count",
    title = "SF Homeless Population Counts Over Time"
  ) 

ggplot(longPITandHDIS[longPITandHDIS$LOCATION_ID == "CA-501",], aes(x = factor(year), y = Count, color = Count_Type, group = Count_Type)) +
  geom_line(size = 1) +  # Draw the lines
  geom_point(size = 2) +  # Add points to the lines
  geom_text(aes(label = Count), 
            size = 2.5, vjust = -0.5, hjust = 0.5) +  # Add labels to points
  labs(
    x = "Year",
    y = "Count",
    title = "SF Homeless Population Counts Over Time"
  )
```
```{r}
ggplot(longPITandHDIS[longPITandHDIS$LOCATION_ID == "CA-503",], aes(x = factor(year), y = Count, color = Count_Type, group = Count_Type)) +
  geom_line(size = 1) +  # Draw the lines
  geom_point(size = 2) +  # Add points to the lines
  geom_text(aes(label = Count), 
            size = 2.5, vjust = -0.5, hjust = 0.5) +  # Add labels to points
  labs(
    x = "Year",
    y = "Count",
    title = "Sac Homeless Population Counts Over Time"
  )
```
```{r}
ggplot(longPITandHDIS[longPITandHDIS$LOCATION_ID == "CA-600",], aes(x = factor(year), y = Count, color = Count_Type, group = Count_Type)) +
  geom_line(size = 1) +  # Draw the lines
  geom_point(size = 2) +  # Add points to the lines
  geom_text(aes(label = Count), 
            size = 2.5, vjust = -0.5, hjust = 0.5) +  # Add labels to points
  labs(
    x = "Year",
    y = "Count",
    title = "LA Homeless Population Counts Over Time"
  )
```
change over time
```{r}
PITandHDISchange <- PITandHDIS %>%
    group_by(LOCATION_ID) %>%
    filter(year == min(year) | year == max(year)) %>%
    summarise(pit_change = pittotal_count[year == max(year)] - pittotal_count[year == min(year)],
              pit_pct_change = (pittotal_count[year == max(year)] - pittotal_count[year == min(year)])/pittotal_count[year == min(year)],
              sheltered_change = `Sheltered Total Homeless`[year == max(year)] - `Sheltered Total Homeless`[year == min(year)],
              sheltered_pct_change = (`Sheltered Total Homeless`[year == max(year)] - `Sheltered Total Homeless`[year == min(year)])/`Sheltered Total Homeless`[year == min(year)],
              unsheltered_change = `Unsheltered Homeless`[year == max(year)] - `Unsheltered Homeless`[year == min(year)],
              unsheltered_pct_change = (`Unsheltered Homeless`[year == max(year)] - `Unsheltered Homeless`[year == min(year)])/`Unsheltered Homeless`[year == min(year)],
              hdis_change = hdistotal_count[year == max(year)] - hdistotal_count[year == min(year)],
              hdis_pct_change = (hdistotal_count[year == max(year)] - hdistotal_count[year == min(year)])/hdistotal_count[year == min(year)],
              permhousing_change = total_permanent_housing[year == max(year)] - total_permanent_housing[year == min(year)],
              permhousing_pct_change = (total_permanent_housing[year == max(year)] - total_permanent_housing[year == min(year)])/total_permanent_housing[year == min(year)], 
              shelter_change = `Total Year-Round Beds (ES, TH, SH)`[year == max(year)] - `Total Year-Round Beds (ES, TH, SH)`[year == min(year)],
              shelter_pct_change = (`Total Year-Round Beds (ES, TH, SH)`[year == max(year)] - `Total Year-Round Beds (ES, TH, SH)`[year == min(year)])/`Total Year-Round Beds (ES, TH, SH)`[year == min(year)], 
              COC_Name = `CoC Name`
                  )
PITandHDISchange <- distinct(PITandHDISchange) 
```
looking for trends 

```{r}

PITandHDISchange[PITandHDISchange$LOCATION_ID != "All",] %>% 
    filter(permhousing_pct_change < 5 & permhousing_pct_change > -0.9) %>%
ggplot(aes(x = permhousing_pct_change, y = pit_pct_change)) +
    geom_point(color = "blue", size = 2) +
    geom_smooth(method = "lm", se = TRUE, color = "red") +
    geom_text(aes(label = COC_Name),
              size = 1.9) +
    labs(
        x = "percentage change in permanent housing 2019 - 2023 by Coc",
        y = "percentage change in PIT totals 2019 - 2023 by CoC",
        title = "relationship between rate of permanent housing development and total homelessness"
    )
```
comparing to change in FMR
```{r}
countyname_vector <- c("NA", "Santa Clara County", "San Francisco County", "Alameda County", "Sacramento County", "Sonoma County", "Contra Costa County", "NA", "Marin County", "Santa Cruz County", "Mendocino County", "Stanislaus County", "San Joaquin County", "San Mateo County", "NA", "NA", "Placer County", "NA", "Napa County", "Solano County","Butte County", "Merced County", "Yolo County", "Humboldt County", "NA", "NA", "El Dorado County", "NA", "Tehama County", "Lake County", "NA", "Nevada County", "Los Angeles County", "San Diego County", "Orange County", "Santa Barbara County", "Kern County", "NA", "NA", "Riverside County", "San Bernadino", "Ventura County", "NA", "Imperial County", "San Luis Obispo")
PITandHDISchange$County_Name <- countyname_vector


